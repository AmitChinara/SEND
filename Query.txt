CREATE OR REPLACE TEMPORARY TABLE Transformed_Table AS (
    SELECT
        CURRENT_TIMESTAMP AS LOAD_DTM,
        '?(RUN ID)' AS RUN_ID,
        '?(SCRTY LVL CD)' AS SCRTY_LVL_CD,
        '?(LOB CD)' AS LOB_CD,
        '?(EXTRNL LOAD CD)' AS EXTRNL_LOAD_CD,
        MDASVS.EDL_SOR_CD,
        MDASVS.MBR_KEY,
        MDASVS.UNIQUE_ATRIB_ID,
        MDASVS.ATRB_NM,
        MDASVS.UNIQ_SRC_ID,
        MDASVS.SUB_CTGRY_VAL_TXT,
        MDASVS.SUB_CTGRY_VAL_NM,
        MDASVS.SRC_ATRB_VAL_TXT,
        MDASVS.SRC_ATRB_VAL_NM,
        MDASVS.SRC_ATSIN_TYPE_TXT,
        MDASVS.SRC_ATRB_STRT_DT,
        MDASVS.SRC_ATRB_END_DT,
        MDASVS.STNDRDZD_DTL_ATRB_CD,
        MDASVS.STNDRDZD_DTL_RPTG_ATRB_CD,
        MDASVS.STNDRDZD_DTL_ATRB_NM,
        MDASVS.STNDRDZD_HIGH_LVL_ATRB_CD,
        MDASVS.STNDRDZD_HIGH_LVL_RPTG_ATRB_CD,
        MDASVS.STNDRDZD_HIGH_LVL_ATRB_NM,
        BSPC.SRC_PRTY_NBR
    FROM (
        SELECT
            MDASVS.*,
            ROW_NUMBER() OVER (
                PARTITION BY MDASVS.MBR_KEY, MDASVS.UNIQUE_ATRIB_ID
                ORDER BY MDASVS.SUB_CTGRY_VAL_TXT, BSPC.SRC_PRTY_NBR, MDASVS.SRC_ATRB_STRT_DT DESC
            ) AS rn
        FROM
            MBR_DMGRPHC_ATRB_SRC_VAL_STG MDASVS
            JOIN BOT_SRC_PRTZTN_CONFIG BSPC
            ON MDASVS.UNIQUE_ATRIB_ID = BSPC.UNIQUE_ATRIB_ID
        WHERE
            UPPER(MDASVS.SRC_ATRB_VAL_TXT) NOT IN ('NA', 'UNK', 'UNKNOWN', '', 'NULL')
            AND UPPER(MDASVS.SRC_ATRB_VAL_TXT) NOT IN ('I CHOOSE NOT TO REPLY', 'DECLINED', 'REFUSED TO COMMENT')
            AND (
                UPPER(MDASVS.TRGHT_HIGH_LVL_CD_VAL_DESC) <> 'ASKED BUT NO ANSWER'
                OR (
                    UPPER(MDASVS.TRGHT_HIGH_LVL_CD_VAL_DESC) = 'ASKED BUT NO ANSWER'
                    AND NOT EXISTS (
                        SELECT 1
                        FROM MBR_DMGRPHC_ATRB_SRC_VAL_STG MDASVS_INNER
                        WHERE
                            MDASVS.MBR_KEY = MDASVS_INNER.MBR_KEY
                            AND MDASVS.UNIQUE_ATRIB_ID = MDASVS_INNER.UNIQUE_ATRIB_ID
                            AND UPPER(MDASVS_INNER.SRC_ATRB_VAL_TXT) NOT IN ('NA', 'UNK', 'UNKNOWN', '', 'NULL')
                            AND UPPER(MDASVS_INNER.SRC_ATRB_VAL_TXT) NOT IN ('I CHOOSE NOT TO REPLY', 'DECLINED', 'REFUSED TO COMMENT')
                            AND UPPER(MDASVS_INNER.TRGHT_HIGH_LVL_CD_VAL_DESC) <> 'ASKED BUT NO ANSWER'
                    )
                )
            )
    ) MDASVS
    WHERE
        MDASVS.rn = 1
);

INSERT INTO MBR_DMGRPHC_ATRB_FNL_VAL_STG (
    EDL_LOAD_DTM,
    EDL_RUN_ID,
    EDL_SCRTY_LVL_CD,
    EDL_LOB_CD,
    EDL_EXTRNL_LOAD_CD,
    EDL_SOR_CD,
    MBR_KEY,
    UNIQUE_ATRIB_ID,
    ATRB_NM,
    UNIQ_SRC_ID,
    SUB_CTGRY_VAL_TXT,
    SUB_CTGRY_VAL_NM,
    SRC_ATRB_VAL_TXT,
    SRC_ATRB_VAL_NM,
    SRC_ATSIN_TYPE_TXT,
    SRC_ATRB_STRT_DT,
    SRC_ATRB_END_DT,
    STNDRDZD_DTL_ATRB_CD,
    STNDRDZD_DTL_RPTG_ATRB_CD,
    STNDRDZD_DTL_ATRB_NM,
    STNDRDZD_HIGH_LVL_ATRB_CD,
    STNDRDZD_HIGH_LVL_RPTG_ATRB_CD,
    STNDRDZD_HIGH_LVL_ATRB_NM,
    SRC_PRTY_NBR
)
SELECT
    LOAD_DTM,
    RUN_ID,
    SCRTY_LVL_CD,
    LOB_CD,
    EXTRNL_LOAD_CD,
    EDL_SOR_CD,
    MBR_KEY,
    UNIQUE_ATRIB_ID,
    ATRB_NM,
    UNIQ_SRC_ID,
    SUB_CTGRY_VAL_TXT,
    SUB_CTGRY_VAL_NM,
    SRC_ATRB_VAL_TXT,
    SRC_ATRB_VAL_NM,
    SRC_ATSIN_TYPE_TXT,
    SRC_ATRB_STRT_DT,
    SRC_ATRB_END_DT,
    STNDRDZD_DTL_ATRB_CD,
    STNDRDZD_DTL_RPTG_ATRB_CD,
    STNDRDZD_DTL_ATRB_NM,
    STNDRDZD_HIGH_LVL_ATRB_CD,
    STNDRDZD_HIGH_LVL_RPTG_ATRB_CD,
    STNDRDZD_HIGH_LVL_ATRB_NM,
    SRC_PRTY_NBR
FROM Transformed_Table;
